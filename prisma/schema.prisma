generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String         @id @default(uuid())
  name       String
  username   String         @unique
  email      String         @unique
  password   String
  role       Role           @default(OPERATOR)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  assignedOS ServiceOrder[] @relation("AssignedTechnician")
  osHistory  OSHistory[]
  notifications Notification[]
  preventiveSchedules PreventiveSchedule[]
}

model ServiceOrder {
  id              String      @id @default(uuid())
  date            DateTime    @default(now())
  machine         String
  machineCode     String
  maintenanceType String
  situation       String
  technicianId    String
  description     String
  contactPerson   String
  sector          String
  status          OSStatus    @default(OPEN)
  priority        Priority    @default(MEDIUM)
  queueOrder      Int?        // Ordem na fila do operador (apenas OS OPEN)
  photos          String[]
  completionNote  String?
  cost            Float?
  completedAt       DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  hadCost           Boolean?
  needsPurchase     Boolean?
  nfDocument        String?
  machineStopped    Boolean?    // Máquina parada (SIM/NÃO) na criação
  machineStoppedAt  DateTime?   // Início máquina parada (quando SIM); fim = completedAt
  operatorStartedAt DateTime?   // Quando operador clicou "Iniciar OS"; fim = completedAt
  technician        User        @relation("AssignedTechnician", fields: [technicianId], references: [id])
  history         OSHistory[]
  alerts          ServiceOrderAlert[]

  @@index([technicianId])
  @@index([status])
  @@index([date])
  @@index([sector])
  @@index([createdAt])
  @@index([status, date])
  @@index([technicianId, status])
}

model Configuration {
  id        String   @id @default(uuid())
  type      String   @unique
  values    String[]
  updatedAt DateTime @updatedAt
}

model Budget {
  id            String   @id @default(uuid())
  year          Int      @unique
  totalAmount   Float
  monthlyAmount Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model OSHistory {
  id            String       @id @default(uuid())
  serviceOrderId String
  userId        String
  message       String
  photos        String[]
  createdAt     DateTime     @default(now())
  serviceOrder  ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id])

  @@index([serviceOrderId])
  @@index([userId])
  @@index([createdAt])
}

model ServiceOrderAlert {
  id                   String       @id @default(uuid())
  serviceOrderId       String
  alertDate            DateTime     // Data em que o alerta deve aparecer
  description          String
  notificationDelivered Boolean     @default(false) // Notificação já criada para o dia
  createdAt            DateTime     @default(now())
  serviceOrder         ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
  @@index([alertDate])
  @@index([alertDate, notificationDelivered])
}

enum Role {
  ADMIN
  OPERATOR
}

enum OSStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?  // Link para a OS ou página relacionada
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
}

enum NotificationType {
  NEW_OS              // Nova OS criada
  OS_COMMENT          // Comentário em OS
  OS_NEEDS_PURCHASE   // OS marcada como necessária compra
  OS_COMPLETED        // OS finalizada
  OS_UPDATED          // OS atualizada
  OS_ALERT            // Alerta programado da OS (data + descrição)
  PREVENTIVE_ASSIGNED       // Preventiva atribuída a operador
  PREVENTIVE_DUE_SOON       // Preventiva próxima (7 dias)
  PREVENTIVE_DUE_TODAY      // Preventiva hoje
  PREVENTIVE_OVERDUE        // Preventiva atrasada
  PREVENTIVE_COMPLETED      // Preventiva finalizada por operador
}

// --- Módulo Manutenção Preventiva (separado de ServiceOrder) ---

model PreventiveEquipment {
  id        String   @id @default(uuid())
  name      String   // Ex: "Taurus (2289)"
  machine   String   // Centro de custo
  machineCode String // Código da máquina
  category  String   // Ex: "máquinas de corte", "predial"
  frequency PreventiveFrequency
  active    Boolean  @default(true)
  schedules PreventiveSchedule[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([machine, active])
  @@index([category, active])
}

model PreventiveSchedule {
  id                String                    @id @default(uuid())
  equipmentId       String
  year              Int
  month             Int
  period            Int   // 1, 2 ou 3 (decêndio)
  status            PreventiveStatus
  assignedType      PreventiveAssignedType?
  technicianId      String?
  outsourcedCompany String?
  outsourcedContact String?
  scheduledDate     DateTime?
  startedAt         DateTime?
  completedDate     DateTime?
  duration          Int?
  workDescription   String?
  observations      String?
  photos            String[]
  cost              Float?
  nfDocument       String?
  equipment         PreventiveEquipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  technician        User?                     @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt

  @@unique([equipmentId, year, month, period])
  @@index([technicianId, status, assignedType])
  @@index([year, month, status])
  @@index([scheduledDate])
}

enum PreventiveFrequency {
  QUARTERLY   // 3 meses - 4x ao ano
  BIMONTHLY   // 2 meses - 6x ao ano
  SEMIANNUAL  // 6 meses - 2x ao ano
  ANNUAL      // 12 meses - 1x ao ano
}

enum PreventiveStatus {
  PLANNED     // Planejada (ainda não atribuída)
  SCHEDULED   // Agendada (com operador/terceirizado definido)
  IN_PROGRESS // Em execução (operador interno iniciou)
  COMPLETED   // Concluída
  NOT_DONE    // Não realizada
  CANCELLED   // Cancelada
}

enum PreventiveAssignedType {
  INTERNAL   // Operador interno
  OUTSOURCED // Terceirizado
}
